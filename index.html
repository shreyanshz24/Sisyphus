<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Josephus Game Fixed</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
body, html { margin:0; padding:0; width:100%; height:100%; font-family:'Press Start 2P', cursive; background: linear-gradient(#87CEEB, #87CEFA); overflow:hidden; }
#menu, #gameUI { position:absolute; top:0; left:0; width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; }
button { font-family:'Press Start 2P', cursive; font-size:18px; padding:20px 40px; margin:10px; background:#7B3F00; color:#FFF; border:none; border-radius:4px; cursor:pointer; box-shadow:4px 4px 0px #000; }
button:hover { background:#A0522D; }
#settings { display:flex; flex-direction:column; align-items:center; margin-top:20px; }
label { margin:5px; font-size:12px; }
canvas { border:2px solid #000; background:white; margin-top:20px; }
#powerups { margin-top:10px; }
.powerup { font-size:30px; cursor:pointer; margin:0 5px; }
#result { margin-top:10px; font-size:14px; text-align:center; }
#leaderboard { position:absolute; top:10px; right:10px; width:300px; background:white; border:2px solid #000; padding:10px; display:none; }
#leaderboard h3 { margin:0 0 10px 0; text-align:center; }
#leaderboard ul { padding-left:20px; font-size:12px; }
</style>
</head>
<body>

<div id="menu">
<h1>JOSEPHUS GAME</h1>
<button id="classicBtn">Classic Mode</button>
<button id="stepBtn">Step-by-Step Mode</button>
<button id="puzzleBtn">Puzzle Mode</button>
<button id="endlessBtn">Endless Survival</button>
<button id="leaderboardBtn">Leaderboard</button>
</div>

<div id="gameUI" style="display:none;">
<div id="settings"></div>
<canvas id="gameCanvas" width="600" height="600"></canvas>
<div id="powerups"></div>
<div id="result"></div>
<button id="nextStepBtn" style="display:none;">Next Step ➡️</button>
</div>

<div id="leaderboard">
<h3>Leaderboard</h3>
<ul id="scoreList"></ul>
<button onclick="document.getElementById('leaderboard').style.display='none'">Close</button>
</div>

<script>
const menu=document.getElementById('menu'), gameUI=document.getElementById('gameUI');
const settingsDiv=document.getElementById('settings'), canvas=document.getElementById('gameCanvas');
const ctx=canvas.getContext('2d'), nextStepBtn=document.getElementById('nextStepBtn');
const powerupsDiv=document.getElementById('powerups'), resultDiv=document.getElementById('result');
const scoreList=document.getElementById('scoreList');

let mode, n, k, playerSeat, avatar, theme='classic';
let players=[], eliminated=[], index=0, step=0, interval=null, playerGuess=null;
let shieldUsed=false, shieldActive=false, particles=[];

const otherAvatars=["😎","🤖","🐱","🐶","👻","👽","🦄","🐵","🦊","🦖","🦋","🎃","💀","🐸","🦁"];

function getRandomAvatar(){ return otherAvatars[Math.floor(Math.random()*otherAvatars.length)]; }

function showSettings(selectedMode){
  mode = selectedMode;
  settingsDiv.innerHTML='';
  let html=`<label>Number of players: <input type="number" id="numPlayers" value="10" min="2"></label>
  <label>Step size (k): <input type="number" id="stepSize" value="3" min="2"></label>
  <label>Your seat: <input type="number" id="playerSeat" value="1" min="1"></label>
  <label>Your avatar: <input type="text" id="avatar" value="🙂" maxlength="2"></label>
  <label>Theme: <select id="theme"><option value="classic">Classic</option><option value="space">Space 🚀</option><option value="zombie">Zombie 🧟</option></select></label>`;
  if(mode==='puzzle') html+=`<label>Guess safe spot: <input type="number" id="guessInput" min="1"></label><button id="submitGuessBtn">Submit Guess</button>`;
  html+=`<button id="startGameBtn">Start Game</button>`;
  settingsDiv.innerHTML = html;
  document.getElementById('startGameBtn').onclick = startGame;
  if(mode==='puzzle') document.getElementById('submitGuessBtn').onclick = submitGuess;
}

function startGame(){
  n=parseInt(document.getElementById('numPlayers').value);
  k=parseInt(document.getElementById('stepSize').value);
  playerSeat=parseInt(document.getElementById('playerSeat').value);
  avatar=document.getElementById('avatar').value||'🙂';
  theme=document.getElementById('theme').value;
  if(playerSeat<1||playerSeat>n){alert("Your seat must be 1-"+n); return;}
  menu.style.display='none'; gameUI.style.display='flex';
  shieldUsed=false; shieldActive=false; particles=[];
  initGame();
  nextStepBtn.style.display = (mode==='step')?'inline-block':'none';
}

function initGame(){
  players=[]; eliminated=[]; index=0; step=0;
  for(let i=1;i<=n;i++){ players.push({seat:i,avatar:(i===playerSeat)?avatar:getRandomAvatar()}); }
  drawCircle();
  if(mode==='classic'||mode==='endless') interval=setInterval(eliminationStep,700);
}

function eliminationStep(){
  if(players.length<=1){ clearInterval(interval); return; }
  step++; if(step>=k){
    const el=players[index];
    if(el.seat===playerSeat && shieldActive){ shieldActive=false; index++; step=0; drawCircle(); return; }
    eliminated.push(players[index]); particlesCreate(index); players.splice(index,1); step=0;
  } else index++;
  if(index>=players.length) index=0;
  drawCircle();
}

function particlesCreate(playerIndex){
  const total=players.length+eliminated.length;
  const angle=(2*Math.PI*playerIndex)/total-Math.PI/2;
  const radius=200, cx=canvas.width/2, cy=canvas.height/2;
  const x=cx+radius*Math.cos(angle), y=cy+radius*Math.sin(angle);
  for(let i=0;i<15;i++){ 
    const a=Math.random()*2*Math.PI, s=Math.random()*3+1;
    particles.push({x:x,y:y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,alpha:1});
  }
}

function drawParticles(){
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i]; p.x+=p.vx; p.y+=p.vy; p.alpha-=0.05;
    if(p.alpha<=0) particles.splice(i,1);
    else { ctx.fillStyle=`rgba(255,165,0,${p.alpha})`; ctx.beginPath(); ctx.arc(p.x,p.y,4,0,2*Math.PI); ctx.fill(); }
  }
}

function drawCircle(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const radius=200,cx=canvas.width/2,cy=canvas.height/2;
  const total=players.length+eliminated.length;
  for(let i=0;i<total;i++){
    const angle=(2*Math.PI*i)/total-Math.PI/2;
    const x=cx+radius*Math.cos(angle),y=cy+radius*Math.sin(angle);
    ctx.beginPath(); ctx.arc(x,y,22,0,2*Math.PI);
    const playerObj=players.find(p=>p.seat===i+1);
    ctx.fillStyle=playerObj?((playerObj.seat===playerSeat)?'lightgreen':'skyblue'):'red';
    ctx.fill(); ctx.stroke();
    if(playerObj) ctx.fillText(playerObj.avatar,x,y);
    else ctx.fillText('💀',x,y);
  }
  drawParticles();
  requestAnimationFrame(drawCircle);
}

// --- Button bindings ---
document.getElementById('classicBtn').onclick=()=>showSettings('classic');
document.getElementById('stepBtn').onclick=()=>showSettings('step');
document.getElementById('puzzleBtn').onclick=()=>showSettings('puzzle');
document.getElementById('endlessBtn').onclick=()=>showSettings('endless');
document.getElementById('leaderboardBtn').onclick=()=>alert('Leaderboard placeholder');
nextStepBtn.onclick=eliminationStep;

</script>
</body>
</html>